SELECT 
    DATE_FORMAT(periods.month_start, '%Y-%m') AS report_month, -- Format the month start date for reporting
    j.queue_id, -- Include the queue ID for grouping and reporting purposes

    -- Calculate the GPU utilization for the month
    -- Utilization = (Total GPU Hours Used / Total Available GPU Hours) * 100
    ROUND(
        SUM(
            TIMESTAMPDIFF(
                SECOND, 
                GREATEST(j.start_time, periods.month_start), 
                LEAST(IFNULL(j.complete_date, periods.month_end), periods.month_end)
            ) / 3600 * j.ngpu
        ) / 
        (
            CASE
                WHEN j.queue_id = 'mlaas' THEN 40
                WHEN j.queue_id = 'mlaas_a100' THEN 20
                WHEN j.queue_id = 'mlaas_h100' THEN 48
                ELSE 40 -- Default for other queue IDs
            END * DATEDIFF(periods.month_end, periods.month_start) * 24
        ) * 100, 2
    ) AS utilization_percentage
FROM (
    -- Generate a list of start and end dates for the last 6 months
    SELECT 
        DATE_ADD(LAST_DAY(DATE_SUB(NOW(), INTERVAL 1 MONTH)), INTERVAL 1 DAY) AS month_start,
        LAST_DAY(NOW()) AS month_end
) periods
LEFT JOIN jobs j -- Join jobs table to the generated period ranges
    ON j.start_time < periods.month_end -- Job starts before the period's end date
    AND j.start_time != '0000-00-00 00:00:00' -- Exclude invalid start times
    AND (j.complete_date > periods.month_start OR j.complete_date IS NULL) -- Include relevant jobs
WHERE
    j.queue_id IN ('mlaas', 'mlaas_a100', 'mlaas_h100') -- Filter by relevant queues
GROUP BY 
    periods.month_start, periods.month_end, j.queue_id -- Group by reporting period and queue ID
ORDER BY 
    periods.month_start DESC; -- Order by most recent months first
