SELECT
    -- Format the month start date into 'YYYY-MM' format for reporting.
    DATE_FORMAT(DATE_SUB(LAST_DAY(NOW()), INTERVAL 1 MONTH), '%Y-%m') AS report_month,

    -- Include the queue ID for grouping and reporting purposes.
    j.queue_id,

    -- Calculate the GPU utilization for the previous month.
    ROUND(
        (
            SUM(
                TIMESTAMPDIFF(
                    SECOND,
                    GREATEST(j.start_time, DATE_SUB(LAST_DAY(NOW()), INTERVAL 1 MONTH)),
                    LEAST(IFNULL(j.complete_date, LAST_DAY(NOW())), LAST_DAY(NOW()))
                ) / 3600 * j.ngpu
            ) / (
                -- Total available hours in the month = GPU Count * Days in Month * Hours in a Day.
                CASE
                    WHEN j.queue_id = 'mlaas' THEN 40
                    WHEN j.queue_id = 'mlaas_a100' THEN 20
                    WHEN j.queue_id = 'mlaas_h100' THEN 48
                END * DATEDIFF(LAST_DAY(NOW()), DATE_SUB(LAST_DAY(NOW()), INTERVAL 1 MONTH)) * 24
            )
        ) * 100, 2
    ) AS utilization_percentage
FROM job_hal_mlaas j
-- Filter jobs that are active during the previous month
WHERE
    -- Ensure jobs that start before the month but overlap with it are included.
    j.start_time < LAST_DAY(NOW()) AND
    j.start_time != '0000-00-00 00:00:00' AND
    -- Ensure jobs that end after the month or are incomplete are included.
    (j.complete_date >=
